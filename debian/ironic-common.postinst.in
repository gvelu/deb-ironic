#!/bin/sh

set -e

CONF=/etc/ironic/ironic.conf

#PKGOS-INCLUDE#

manage_enabled_drivers_field () {
	db_get ironic/enabled_drivers
	if [ -n "${RET}" ] ; then
		ENABLED_DRIVERS=`echo ${RET} | sed "s/ //g"`
		pkgos_inifile set ${CONF} DEFAULT enabled_drivers ${ENABLED_DRIVERS}
	fi
}

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ] ; then
	. /usr/share/debconf/confmodule
	. /usr/share/dbconfig-common/dpkg/postinst
	pkgos_var_user_group ironic
	pkgos_write_new_conf ironic ironic.conf
	pkgos_rabbit_write_conf ${CONF} DEFAULT ironic
	pkgos_write_admin_creds ${CONF} keystone_authtoken ironic
	manage_enabled_drivers_field
	db_get ironic/configure_db
	if [ "$RET" = "true" ] ; then
		pkgos_dbc_postinst /etc/ironic/ironic.conf database connection ironic $@
		ironic-dbsync
	fi
	db_stop
fi

#DEBHELPER#

exit 0
